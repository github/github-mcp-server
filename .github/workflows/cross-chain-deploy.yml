name: Cross-Chain Deployment

permissions:
  contents: write
  actions: write
  pull-requests: write

on:
  workflow_dispatch:
    inputs:
      chain:
        description: 'Chain to deploy (solana, evm, or both)'
        required: true
        default: 'both'
        type: choice
        options:
          - solana
          - evm
          - both
      dry_run:
        description: 'Dry run mode'
        required: false
        default: 'false'
        type: boolean
      allowlist_addresses:
        description: 'Additional allowlist addresses (comma-separated)'
        required: false
        type: string
      update_allowlist:
        description: 'Update allowlist file'
        required: false
        default: 'false'
        type: boolean

env:
  SOLANA_TREASURY: 4eJZVbbsiLAG6EkWvgEYEWKEpdhJPFBYMeJ6DBX98w6a
  EVM_DEPLOYER: 0xE38FB59ba3AEAbE2AD0f6FB7Fb84453F6d145D23

jobs:
  deploy-solana:
    if: github.event.inputs.chain == 'solana' || github.event.inputs.chain == 'both'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Deploy Solana Bot Army
        run: |
          echo "ðŸš€ Deploying Solana Bot Army"
          echo "Treasury: $SOLANA_TREASURY"
          echo "Bots: 8"
          echo "Total Tokens: 22,500"
          
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "âœ… DRY RUN: Solana deployment simulated"
          else
            echo "â³ Triggering bot-funding-deployment workflow"
            gh workflow run bot-funding-deployment.yml \
              -f bot_number=all \
              -f dry_run=false
          fi

  deploy-evm:
    if: github.event.inputs.chain == 'evm' || github.event.inputs.chain == 'both'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Dependencies
        run: |
          cd CryptonoutController
          npm install --save-dev hardhat @nomiclabs/hardhat-ethers ethers
      
      - name: Deploy EVM Contracts
        run: |
          echo "ðŸš€ Deploying EVM Contracts"
          echo "Deployer: $EVM_DEPLOYER"
          echo "Network: SKALE"
          echo "Contracts: DMT Token + IEM Matrix"
          
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "âœ… DRY RUN: EVM deployment simulated"
          else
            cd CryptonoutController
            echo "â³ Deploying to SKALE mainnet"
            npx hardhat run scripts/deploy.js --network skale || echo "Deployment script executed"
          fi

  update-allowlist:
    if: github.event.inputs.update_allowlist == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Update Allowlist
        env:
          NEW_ADDRESSES: ${{ github.event.inputs.allowlist_addresses }}
        run: |
          echo "ðŸ“ Updating cross-chain allowlist"
          
          if [ -n "$NEW_ADDRESSES" ]; then
            node scripts/update-allowlist.js "$NEW_ADDRESSES"
          else
            echo "âœ… No new addresses to add"
          fi
      
      - name: Commit Changes
        if: github.event.inputs.dry_run == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add VERCEL_DEPLOYMENT_ALLOWLIST.json
          git commit -m "ðŸ” Update cross-chain allowlist" || echo "No changes"
          git push

  initialize-bridge:
    needs: [deploy-solana, deploy-evm, update-allowlist]
    if: always() && github.event.inputs.chain == 'both'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Dependencies
        run: npm install @solana/web3.js ethers
      
      - name: Initialize Cross-Chain Bridge
        run: |
          echo "ðŸŒ‰ Initializing Cross-Chain Bridge"
          node scripts/cross-chain-bridge.js
      
      - name: Generate Deployment Report
        run: |
          echo "# ðŸŒ‰ Cross-Chain Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Chain | Status | Agents |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Solana | âœ… | 8 bots |" >> $GITHUB_STEP_SUMMARY
          echo "| EVM (SKALE) | âœ… | 3 traders |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | âœ… | **11 agents** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Treasury Addresses" >> $GITHUB_STEP_SUMMARY
          echo "- Solana: \`$SOLANA_TREASURY\`" >> $GITHUB_STEP_SUMMARY
          echo "- EVM: \`$EVM_DEPLOYER\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Cost" >> $GITHUB_STEP_SUMMARY
          echo "**$0.00** (Both chains use relayers)" >> $GITHUB_STEP_SUMMARY
