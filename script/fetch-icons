#!/bin/bash
# Fetch Octicon icons and convert them to PNG for embedding in the MCP server.
# Generates both light theme (dark icons) and dark theme (white icons) variants.
# Requires: rsvg-convert (from librsvg2-bin on Ubuntu/Debian), ImageMagick (convert)
#
# Usage:
#   script/fetch-icons              # Fetch all default icons
#   script/fetch-icons icon1 icon2  # Fetch specific icons

set -e

ICONS_DIR="pkg/octicons/icons"
OCTICONS_BASE="https://raw.githubusercontent.com/primer/octicons/main/icons"

# Default icons used by toolsets - add new icons here as needed
DEFAULT_ICONS=(
    apps
    beaker
    bell
    check-circle
    codescan
    comment-discussion
    copilot
    dependabot
    file
    git-branch
    git-merge
    git-pull-request
    issue-opened
    logo-gist
    mark-github
    organization
    people
    person
    project
    repo
    repo-forked
    shield
    shield-lock
    star
    star-fill
    tag
    tools
    workflow
)

# Check for rsvg-convert
if ! command -v rsvg-convert &> /dev/null; then
    echo "Error: rsvg-convert not found. Install with:"
    echo "  Ubuntu/Debian: sudo apt-get install librsvg2-bin"
    echo "  macOS: brew install librsvg"
    exit 1
fi

# Check for ImageMagick convert
if ! command -v convert &> /dev/null; then
    echo "Error: ImageMagick convert not found. Install with:"
    echo "  Ubuntu/Debian: sudo apt-get install imagemagick"
    echo "  macOS: brew install imagemagick"
    exit 1
fi

# Use provided icons or defaults
if [ $# -gt 0 ]; then
    ICONS=("$@")
else
    ICONS=("${DEFAULT_ICONS[@]}")
fi

# Ensure icons directory exists
mkdir -p "$ICONS_DIR"

echo "Fetching ${#ICONS[@]} icons (light + dark themes)..."

for icon in "${ICONS[@]}"; do
    svg_url="${OCTICONS_BASE}/${icon}-16.svg"
    light_file="${ICONS_DIR}/${icon}-light.png"
    dark_file="${ICONS_DIR}/${icon}-dark.png"
    
    echo "  ${icon} (light + dark)"
    
    # Download SVG and convert to PNG (light theme - dark icons for light backgrounds)
    if curl -sfL "$svg_url" | rsvg-convert -o "$light_file" 2>/dev/null; then
        # Create dark theme variant (invert colors for dark backgrounds)
        # -channel RGB inverts only color channels, preserving alpha
        convert "$light_file" -channel RGB -negate "$dark_file"
    else
        echo "    Warning: Failed to fetch ${icon}-16.svg (may not exist)"
        rm -f "$light_file" "$dark_file"
    fi
done

echo "Done. Icons saved to $ICONS_DIR"
echo ""
echo "Remember to:"
echo "  1. Update pkg/octicons/octicons_test.go if adding new icons"
echo "  2. Run 'UPDATE_TOOLSNAPS=true go test ./...' to update snapshots"
